{{ $lang := .Page.Language.Lang }}
{{ $currentPath := .Page.RelPermalink }}
{{ $prefix := cond (eq $lang "en") "/en" "" }}

{{/* Smart language toggle URL generation */}}
{{ $toggle := "/" }}
{{ if eq $lang "en" }}
  {{/* English to Korean */}}
  {{ if eq $currentPath "/en/" }}
    {{ $toggle = "/" }}
  {{ else if hasPrefix $currentPath "/en/" }}
    {{ $toggle = strings.TrimPrefix $currentPath "/en" }}
    {{ if eq $toggle "" }}{{ $toggle = "/" }}{{ end }}
  {{ else }}
    {{ $toggle = "/" }}
  {{ end }}
{{ else }}
  {{/* Korean to English */}}
  {{ if eq $currentPath "/" }}
    {{ $toggle = "/en/" }}
  {{ else if hasPrefix $currentPath "/" }}
    {{ $toggle = printf "/en%s" $currentPath }}
  {{ else }}
    {{ $toggle = "/en/" }}
  {{ end }}
{{ end }}

<div class="cc-fab" aria-label="Quick actions">
  <!-- Essential buttons only -->
  <a class="cc-fab__btn" href="#about" title="Top"><i class="fas fa-arrow-up" aria-hidden="true"></i></a>
  <a class="cc-fab__btn" href="https://github.com/abc202313746" target="_blank" rel="noopener" title="GitHub"><i class="fab fa-github" aria-hidden="true"></i></a>
  <a class="cc-fab__btn" href="https://www.instagram.com/insookyoung/" target="_blank" rel="noopener" title="Instagram"><i class="fab fa-instagram" aria-hidden="true"></i></a>
  <a class="cc-fab__btn cc-fab__language" href="{{ $toggle }}" onclick="smartLanguageToggle(event)" title="Language ({{ if eq $lang "en" }}한국어{{ else }}English{{ end }})"><i class="fas fa-globe" aria-hidden="true"></i></a>
</div>

<script>
// Copy to clipboard function
function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(function() {
    // Show toast notification
    showToast('Link copied to clipboard!');
  });
}

// Show toast notification
function showToast(message) {
  const toast = document.createElement('div');
  toast.className = 'cc-toast';
  toast.textContent = message;
  toast.style.cssText = `
    position: fixed;
    bottom: 100px;
    right: 20px;
    background: var(--bs-primary, #7c4dff);
    color: white;
    padding: 12px 20px;
    border-radius: 25px;
    font-size: 14px;
    z-index: 10000;
    opacity: 0;
    transition: opacity 0.3s ease;
    box-shadow: 0 4px 12px rgba(124, 77, 255, 0.3);
  `;
  document.body.appendChild(toast);
  
  // Animate in
  setTimeout(() => toast.style.opacity = '1', 100);
  
  // Remove after 3 seconds
  setTimeout(() => {
    toast.style.opacity = '0';
    setTimeout(() => document.body.removeChild(toast), 300);
  }, 3000);
}

// Toggle theme function
function toggleTheme() {
  const body = document.body;
  const currentMode = body.getAttribute('data-mode');
  const newMode = currentMode === 'dark' ? 'light' : 'dark';
  body.setAttribute('data-mode', newMode);
  localStorage.setItem('theme', newMode);
  
  // Update icon
  const themeIcon = document.querySelector('.cc-fab__theme i');
  themeIcon.className = newMode === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
  
  showToast(`Switched to ${newMode} mode`);
}

// Toggle search function
function toggleSearch() {
  // Try to trigger the Pagefind search modal
  const searchEvent = new CustomEvent('openPagefindSearch');
  document.dispatchEvent(searchEvent);
  
  // Fallback to regular search input
  const searchInput = document.querySelector('input[type="search"]');
  if (searchInput) {
    searchInput.focus();
    searchInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
    showToast('Search activated');
  } else {
    showToast('Search not available');
  }
}

// Smart language toggle function
function smartLanguageToggle(event) {
  event.preventDefault();
  
  const currentPath = window.location.pathname;
  const currentLang = currentPath.startsWith('/en/') ? 'en' : 'ko';
  let targetUrl = '/';
  
  if (currentLang === 'en') {
    // English to Korean
    if (currentPath === '/en/') {
      targetUrl = '/';
    } else if (currentPath.startsWith('/en/')) {
      targetUrl = currentPath.replace('/en', '');
      if (targetUrl === '') targetUrl = '/';
    } else {
      targetUrl = '/';
    }
  } else {
    // Korean to English
    if (currentPath === '/') {
      targetUrl = '/en/';
    } else {
      targetUrl = '/en' + currentPath;
    }
  }
  
  // Check if target page exists before navigating
  fetch(targetUrl, { method: 'HEAD' })
    .then(response => {
      if (response.ok) {
        window.location.href = targetUrl;
      } else {
        // Fallback to homepage if page doesn't exist
        const fallbackUrl = currentLang === 'en' ? '/' : '/en/';
        window.location.href = fallbackUrl;
        showToast(`Redirected to ${currentLang === 'en' ? 'Korean' : 'English'} homepage`);
      }
    })
    .catch(() => {
      // If fetch fails, try the original URL anyway
      window.location.href = targetUrl;
    });
}

// Initialize theme icon on page load
document.addEventListener('DOMContentLoaded', function() {
  const currentMode = document.body.getAttribute('data-mode') || 'light';
  const themeIcon = document.querySelector('.cc-fab__theme i');
  if (themeIcon) {
    themeIcon.className = currentMode === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
  }
  
  // Update language button tooltip
  updateLanguageButtonTooltip();
});

// Update language button tooltip based on current language
function updateLanguageButtonTooltip() {
  const currentPath = window.location.pathname;
  const currentLang = currentPath.startsWith('/en/') ? 'en' : 'ko';
  const languageBtn = document.querySelector('.cc-fab__language');
  
  if (languageBtn) {
    const targetLang = currentLang === 'en' ? '한국어' : 'English';
    languageBtn.setAttribute('title', `Language (${targetLang})`);
  }
}
</script>
